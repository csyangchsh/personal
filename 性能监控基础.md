# 性能监控基础

## 性能监控定义

### 性能监控

以**非入侵方式**收集或查看应用运行性能数据，是带有预防或主动性的活动。当发现性能问题但没有定位根本原因的线索时，首先会进行性能监控，随后是性能分析。

### 性能分析

以**入侵方式**收集运行性能数据，会影响应用的吞吐量或响应性，很少在生产环境中进行。

### 性能调优

为改善应用响应性或吞吐量而更改参数(Tune-able)、源代码或属性配置的活动。

## 操作系统性能监控

### CPU使用率

* 用户态CPU使用率 (应用代码)
* 系统态CPU使用率 (操作系统调用)

系统态CPU使用率高说明共享资源有竞争或者I/O设备之间有大量的交互。<br />
提高应用性能应该尽可能降低系统态CPU使用率，提高用户态CPU使用率。

### CPU调度程序运行队列

运行队列中是已经准备好运行，正在等待可用CPU的轻量级进程。

系统运行队列长度等于虚拟处理器个数(硬件线程的个数，Runtime.availableProcessors())时，不会感到明显性能下降。

#### 解决运行队列过长的方法

1. 增加CPU分担负载或减少处理器的负载量。（减少了虚拟处理器上的活动线程数，从而减少运行队列中的轻量级进程数。）
2. 分析应用，改进CPU使用率。（算法和数据结构）

### 内存使用率

页面调度 页面交换、加锁、线程迁移中的让步式和抢占式上下文切换

如果发现垃圾收集时间变长，要考虑系统可能在进行页面交换。

#### 锁竞争

#### 抢占式上下文切换

#### 线程迁移

### 网络I/O使用率

单次读写数据量小而网络读写量大会消耗大量的系统态CPU，产生大量的系统调用。

减少网络读写的系统调用。使用非阻塞的Java NIO，减少处理请求和发送响应的线程数。

每次读请求尽可能的多读取数据，每个写调用应该尽可能多写。

### 磁盘I/O使用率

分析磁盘的预期负载量、磁盘服务时间、寻道时间以及服务I/O事件的时间。

#### 改善磁盘使用率

* 更快的存储设备
* 文件系统扩展到多个磁盘
* 操作系统调优使得可以缓存大量的文件系统数据结构
* 使用带缓存的输入输出以减少读写操作次数 (BufferedInputStream/BufferedOutputStream)
* 在应用中集成缓存的数据结构以减少磁盘交换

**开启磁盘缓存可以改善严重依赖磁盘I/O应用的性能。但是，如果开启磁盘缓存，意外的电源故障可能会造成数据损坏。**

## JVM性能监控

**生产环境应该自始自终监控应用JVM。** 分析JVM监控数据，可以知道何时需要JVM调优。

JVM的监控范围包括: **垃圾收集、JIT编译和类加载**。

### 重要的GC数据

* 当前使用的垃圾收集器
* Java Heap的大小
* 新生代和老年代的大小
* 永久代的大小
* Minor GC的持续时间
* Minor GC的频率
* Minor GC的空间回收量
* Full GC的持续时间
* Full GC的频率
* 每个并发垃圾收集周期内的空间回收量
* 垃圾收集前后Java Heap的占用量
* 垃圾收集前后新生代和老年代的占用量
* 垃圾收集前后永久代的占用量
* 是否老年代或永久代的占用触发了Full GC
* 应用是否显示调用了System.gc()

## References

Java性能优化权威指南

